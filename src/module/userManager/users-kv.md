
# 用户配置管理系统 - 产品描述文档

## 1. 项目概述

### 1.1 背景
当前系统通过环境变量 `DB_USER` 管理用户配置，需要登录Cloudflare后台修改，操作繁琐。需要增加从KV存储读取配置的功能，并提供Web前端界面进行可视化配置管理。

### 1.2 目标
- 保留现有环境变量配置方式作为默认配置
- 增加KV存储配置功能，支持动态更新
- 提供Web前端界面进行配置管理
- 实现配置优先级：KV配置 > 环境变量配置

## 2. 功能需求

### 2.1 核心功能

#### 2.1.1 配置读取策略
- **优先级顺序**：
  1. KV存储中的用户配置（最新）
  2. 环境变量 `DB_USER` 中的配置（默认）
- **配置合并**：KV配置会覆盖环境变量中的同名用户配置

#### 2.1.2 用户配置管理
- **用户列表**：显示所有可配置的用户 （超级管理员）
- **配置编辑**：支持编辑单个用户的完整配置 （用户自己只能修改自己的配置）
- **配置验证**：实时验证配置格式和必填字段（参考 UserConfig from '@/types/user.types'） 

#### 2.1.3 权限控制
- **访问控制**：基于 `accessToken` 的用户身份验证
- **操作权限**：只有配置的所有者可以修改自己的配置

### 2.2 Web前端功能

#### 2.2.1 管理界面
- **仪表板**：显示当前配置状态和用户统计（超级管理员）
- **用户管理**：用户列表（超级管理员）
- **配置编辑器**：支持YAML的配置编辑
- **实时预览**：配置修改后的实时预览效果

#### 2.2.2 操作功能
- **配置保存**：保存配置到KV存储  

## 3. 技术架构

### 3.1 后端API设计

#### 3.1.1 配置管理API
```
GET /api/config/users          # 获取所有用户列表（超级管理员）
GET /api/config/users/:userId  # 获取指定用户配置
POST /api/config/users/:userId # 更新用户配置
DELETE /api/config/users/:userId # 删除用户配置
```
 
### 3.2 数据存储设计

#### 3.2.1 KV存储结构
```typescript
// 用户配置存储
`user:${userId}:config` -> UserConfig (YAML格式)

// 配置元数据
`user:${userId}:meta` -> {
  lastModified: string, 
  source: 'kv' | 'env'
}
 
```

#### 3.2.2 配置格式
保持与现有 `UserConfig` 接口兼容：
```typescript
interface UserConfig {
  subscribe: string;
  accessToken: string;
  ruleUrl?: string;
  fileName?: string;
  multiPortMode?: AreaCode[];
  appendSubList?: SubConfig[];
  excludeRegex?: string;
}
```

### 3.3 前端技术栈
- **框架** Alpine.js + TypeScript
- **UI库**：TailwindCSS 
- **编辑器**：Monaco Editor（支持YAML语法高亮）
- **验证**：YAML Schema 验证

## 4. 用户界面设计

### 4.1 主要页面

#### 4.1.1 仪表板页面
- 配置概览卡片 

#### 4.1.2 用户管理页面
- 用户列表表格
- 批量操作功能

#### 4.1.3 配置编辑页面
- 分栏布局（左侧用户列表，右侧编辑器）
- YAML编辑器（语法高亮、错误提示）
- 实时预览面板
- 操作按钮组（保存、重置、导出）

### 4.2 交互设计

#### 4.2.1 配置编辑流程
1. 选择用户 → 2. 加载配置 → 3. 编辑配置 → 4. 验证配置 → 5. 保存配置
2. 用户直接在浏览器输入网址，如：https://domain.com/config/123?token=xxx，进入配置编辑页面

#### 4.2.2 错误处理
- 实时语法检查
- 字段验证提示
- 保存失败重试
- 网络错误处理

## 5. 安全考虑

### 5.1 身份验证
- 基于 `accessToken` 的API认证
- 前端路由保护
- 会话超时处理

### 5.2 数据安全
- KV存储访问权限控制
- 配置数据加密存储
- 操作日志记录

### 5.3 输入验证
- YAML格式验证
- 字段类型检查
- 恶意代码检测

## 6. 部署和运维

### 6.1 部署要求
- Cloudflare Workers KV绑定
- 环境变量配置
- 前端静态资源部署
